name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Debug SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | head -n 5
          echo "SSH Key saved and permissions set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 

      - name: Deploy to Server
        run: |
          ssh -T ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          
          # 1. 배포 경로로 이동
          cd /root/${{ secrets.DEPLOY_PATH }}
          
          # 2. 현재 커밋 해시 저장 
          PREV_COMMIT=$(git rev-parse HEAD)
          
          # 3. release 브랜치 pull 시도
          if ! git pull origin release; then
              git reset --hard "$PREV_COMMIT"
              exit 1
          fi
          
          # 4. 환경변수 설정 및 가상환경 활성화
          export PATH="/root/.local/bin:$PATH"
          source .venv/bin/activate
          
          # 5. Poetry 설치 여부 확인
          if ! command -v poetry >/dev/null 2>&1; then
              exit 1
          fi
          
          # 6. 의존성 설치 
          if ! poetry install --no-interaction --no-root; then
              git reset --hard "$PREV_COMMIT"
              poetry install --no-interaction --no-root
              exit 1
          fi
          
          # 7. DB 마이그레이션 
          if ! python manage.py migrate --noinput; then
              git reset --hard "$PREV_COMMIT"
              python manage.py migrate --noinput
              exit 1
          fi
          
          # 8. Gunicorn 리로드 
          if [ -f /run/gunicorn.pid ]; then
              if ! sudo kill -HUP $(cat /run/gunicorn.pid); then
                  git reset --hard "$PREV_COMMIT"
                  sudo kill -HUP $(cat /run/gunicorn.pid)
                  exit 1
              fi
          fi
          
          # 9. Nginx 재시작
          sudo systemctl restart nginx
          EOF
     
