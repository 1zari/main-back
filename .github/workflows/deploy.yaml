name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Debug SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | head -n 5
          echo "SSH Key saved and permissions set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 

      - name: Deploy to Server
        run: |
          ssh -T ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          cd /root/${{ secrets.DEPLOY_PATH }}
          echo "ðŸ“ í”„ë¡œì íŠ¸ í´ë” ì´ë™"

          echo "ðŸ“Œ í˜„ìž¬ ì»¤ë°‹ ì €ìž¥"
          PREV_COMMIT=\$(git rev-parse HEAD)

          echo "ðŸ“¦ ì½”ë“œ ì—…ë°ì´íŠ¸"
          if ! git pull origin release; then
            echo "âŒ git pull ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
            git reset --hard \$PREV_COMMIT
            exit 1
          fi

          echo "ðŸŒ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë° ê°€ìƒí™˜ê²½ ì§„ìž…"
          export PATH="/root/.local/bin:\$PATH"
          source .venv/bin/activate

          echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
          if ! poetry install; then
            echo "âŒ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
            git reset --hard \$PREV_COMMIT
            poetry install
            exit 1
          fi

          echo "ðŸ§¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰"
          if ! python manage.py migrate; then
            echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
            git reset --hard \$PREV_COMMIT
            python manage.py migrate
            exit 1
          fi

          echo "ðŸš€ Gunicorn ë¦¬ë¡œë“œ"
          if ! sudo kill -HUP \$(cat /run/gunicorn.pid); then
            echo "âŒ Gunicorn ìž¬ì‹œìž‘ ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
            git reset --hard \$PREV_COMMIT
            sudo kill -HUP \$(cat /run/gunicorn.pid)
            exit 1
          fi

          echo "ðŸ” Nginx ìž¬ì‹œìž‘"
          sudo systemctl restart nginx
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF