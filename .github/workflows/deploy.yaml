name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Debug SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | head -n 5
          echo "SSH Key saved and permissions set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 

      - name: Deploy to Server
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          cd /root/${{ secrets.DEPLOY_PATH }}  # 프로젝트 디렉토리 이동
          echo "프로젝트 폴더이동"
          git pull origin release  # 최신 코드 반영
          echo "코드 최신화 완료"
          export PATH="/root/.local/bin:$PATH"
          echo "환경변수 설정"
          source .venv/bin/activate  # 가상환경 설정
          echo "가상환경 활성화"
          poetry install  # 의존성 패키지 설치
          echo "의존성 설치 완료"
          python manage.py migrate  # 마이그레이션 변경 반영
          echo "마이그레이션 완료"
          sudo kill -HUP $(cat /run/gunicorn.pid)  # 기존 실행 중이던 gunicorn 프로세서를 HUP로 KILL
          echo "Gunicron HUP 작동"
          sudo systemctl restart nginx  # nginx 서버 재시작
          echo "Nginx 서버 재시작완료"
          EOF
