name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Debug SSH Keyscan
        run: |
          ssh-keyscan -H 211.188.53.238 > output.txt
          cat output.txt
          echo "SSH Keyscan output saved and printed."

      - name: Debug SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | head -n 5
          echo "SSH Key saved and permissions set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@211.188.53.238 << 'EOF'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}  # 프로젝트 디렉토리
          git pull origin release  # 최신 코드 반영
          source .venv/bin/activate  # 가상환경 설정
          poetry install  # 의존성 패키지 설치
          python manage.py migrate  # 마이그레이션 변경 반영
          python manage.py collectstatic --noinput  # Django admin 위한 정적파일 복사
          sudo kill -HUP $(cat /run/gunicorn.pid)  # 기존 실행 중이던 gunicorn 프로세서를 HUP로 KILL
          sudo systemctl restart nginx  # nginx 서버 재시작
          EOF
