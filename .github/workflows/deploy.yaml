name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa  # pub키의 key pair (private key) 
          chmod 600 ~/.ssh/id_rsa # 읽고 쓰는 권한 
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts # 서버 신뢰할수있는 사용자등록

      - name: Deploy to Server
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF' #user, IP 설정
            set -e
            cd ${{ secrets.DEPLOY_PATH }} # 프로젝트 디렉토리
            git pull origin release #최신 코드 반영
            source .venv/bin/activate  # 가상환경 설정
            poetry install  # 의존성 패키지 설치 
            python manage.py migrate # 마이그레이션 변경 반영  
            python manage.py collectstatic --noinput  #django admin 위한 정적파일 복사 
            sudo kill -HUP $(cat /run/gunicorn.pid) #기존 실행중이던 gunicorn 프로세서를 HUP로 KILL 
          # 실행중이던 작업을 마무리 한 프로세서를 자동으로 KILL 하고 최신코드 반영된 프로세서 재생성함.
            sudo sytemctl restart nginx # nginx 서버 재시작 
          EOF
