name: Deploy to NCP Server

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Debug SSH Key
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" | head -n 5
          echo "SSH Key saved and permissions set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 

      - name: Deploy to Server
        run: |
          ssh -T ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e
          cd /root/${{ secrets.DEPLOY_PATH }}
          echo "[STEP] 프로젝트 폴더 이동"
          
          echo "[STEP] 현재 커밋 저장"
          PREV_COMMIT=\$(git rev-parse HEAD)
          
          echo "[STEP] 코드 업데이트"
          if ! git pull origin release; then
            echo "[ERROR] git pull 실패! 롤백 중..."
            git reset --hard \$PREV_COMMIT
            exit 1
          fi
          
          echo "[STEP] 환경변수 설정 및 가상환경 진입"
          export PATH="/root/.local/bin:\$PATH"
          source .venv/bin/activate
          
          echo "[STEP] 의존성 설치"
          if ! poetry install; then
            echo "[ERROR] 의존성 설치 실패! 롤백 중..."
            git reset --hard \$PREV_COMMIT
            poetry install
            exit 1
          fi
          
          echo "[STEP] 마이그레이션 수행"
          if ! python manage.py migrate; then
            echo "[ERROR] 마이그레이션 실패! 롤백 중..."
            git reset --hard \$PREV_COMMIT
            python manage.py migrate
            exit 1
          fi
          
          echo "[STEP] Gunicorn 리로드"
          if ! sudo kill -HUP \$(cat /run/gunicorn.pid); then
            echo "[ERROR] Gunicorn 재시작 실패! 롤백 중..."
            git reset --hard \$PREV_COMMIT
            sudo kill -HUP \$(cat /run/gunicorn.pid)
            exit 1
          fi
          
          echo "[STEP] Nginx 재시작"
          sudo systemctl restart nginx
          echo "[SUCCESS] 배포 완료!"
          EOF
     
